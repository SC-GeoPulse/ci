name: Build
on:
    workflow_dispatch:
    repository_dispatch:
    push:
      paths:
        - '.github/workflows/build.yml'
        - '*.sh'
      branches:
        - master

permissions:
  contents: write

concurrency:
  group: ${{ github.ref }}-${{ github.event.client_payload.ref || 'refs/heads/master'}}
  cancel-in-progress: true

jobs:
    ci:
        name: Build
        if: ${{ !github.event.client_payload.ref || github.event.client_payload.ref == 'refs/heads/master' }}
        runs-on: ubuntu-latest
        env:
            REPO_BACKEND: backend
            REPO_CI: ci
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Deploy Keys
              env:
                GP_BACKEND: ${{ secrets.GP_BACKEND }}
                GP_FRONTEND: ${{ secrets.GP_FRONTEND }}
                GP_CI: ${{ secrets.GP_CI }}
              run: |
                ./keys.sh --all

            - name: Build and Test Backend
              run: |
                git clone --recurse-submodules \
                  git@backend.geopulse:${{ github.repository_owner }}/${{ env.REPO_BACKEND }}.git \
                  ${{ github.workspace }}/backend

                pushd ${{ github.workspace }}/backend

                ${{ github.workspace }}/report.sh \
                  --state "pending" \
                  --description "GitHub Actions workflow requested" \
                  --token ${{ secrets.GP_GITHUB_TOKEN }} \
                  --repo ${{ env.REPO_BACKEND }} \
                  --commit $(git rev-parse HEAD)

                ./build.sh auth
                ./build.sh geo
                ./build.sh mgnt

                popd

            - name: Create Release
              if: ${{ github.ref == 'refs/heads/master' }}
              uses: marvinpinto/action-automatic-releases@latest
              with:
                repo_token: "${{ secrets.GITHUB_TOKEN }}"
                automatic_release_tag: geopulse-${{ github.run_number }}-${{ github.run_attempt }}
                prerelease: false
                title: GeoPulse
                files: |
                    ${{ github.workspace }}/backend/out/auth
                    ${{ github.workspace }}/backend/out/geo
                    ${{ github.workspace }}/backend/out/mgnt

            - name: Write Dockerfile
              if: ${{ github.ref == 'refs/heads/master' }}
              run: |
                git clone git@ci.geopulse:${{ github.repository_owner }}/${{ env.REPO_CI }}.git \
                  ${{ github.workspace }}/ci -b deploy

                pushd ${{ github.workspace }}/ci

                DATE=$(date)

                COMPONENTS=("auth" "geo" "mgnt")
                for COMPONENT in "${COMPONENTS[@]}"; do
                  echo "# Generated by GeoPulse CI on $DATE.
                  # DO NOT EDIT.

                  FROM ubuntu:latest

                  # Download archive
                  ADD "${{ github.server_url }}/${{ github.repository }}/releases/latest/download/$COMPONENT" $COMPONENT

                  # Load development secrets & copy for publish
                  RUN --mount=type=secret,id=config_local_json,dst=/etc/secrets/config.local.json \
                      cp /etc/secrets/config.local.json .

                  WORKDIR /App

                  COPY --from=build-env /App .
                  ENTRYPOINT [\"$COMPONENT\"]

                  " > Dockerfile.$COMPONENT
                done

                git add .

                git config user.name "GeoPulse CI"
                git config user.email "no-reply+ci@gp.trungnt2910.com"

                git commit -m "deploy: $DATE"
                git push

                popd

            - name: Mark Commit Success
              if: success()
              run: |
                pushd ${{ github.workspace }}/backend
                ${{ github.workspace }}/report.sh \
                  --state "success" \
                  --description "GitHub Actions workflow succeeded" \
                  --token ${{ secrets.GP_GITHUB_TOKEN }} \
                  --repo ${{ env.REPO_BACKEND }} \
                  --commit $(git rev-parse HEAD)
                popd

            - name: Mark Commit Failure
              if: failure()
              run: |
                if [ -d "${{ github.workspace }}/backend" ]; then
                  pushd ${{ github.workspace }}/backend
                  ${{ github.workspace }}/report.sh \
                    --state "failure" \
                    --description "GitHub Actions workflow failed" \
                    --token ${{ secrets.GP_GITHUB_TOKEN }} \
                    --repo ${{ env.REPO_BACKEND }} \
                    --commit $(git rev-parse HEAD)
                  popd
                fi
